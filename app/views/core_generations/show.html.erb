<div class="max-w-7xl mx-auto">
  <div class="md:flex md:items-center md:justify-between mb-6">
    <div class="min-w-0 flex-1">
      <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">Core Locations</h2>
      <p class="mt-1 text-sm text-gray-500">
        Lot <strong><%= @lot.lot_number %></strong>
        â€” Seed: <code class="bg-gray-100 px-1 py-0.5 rounded text-gray-800"><%= @core_generation.seed %></code>
      </p>
    </div>
    <div class="mt-4 flex md:mt-0 md:ml-4 space-x-3">
        <%= link_to "Back to Lot", lot_path(@lot), class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none" %>
        <%= link_to "Generate Again", new_lot_core_generation_path(@lot), class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none" %>
        <%= link_to export_xlsx_lot_core_generation_path(@lot, @core_generation), class: "inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none" do %>
            <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Export Excel
        <% end %>
    </div>
  </div>

  <div class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    <%= link_to lot_core_generation_path(@lot, @core_generation, sort: @sort_by_sublot ? nil : 'sublot'), class: "inline-flex items-center hover:text-gray-700" do %>
                        <span class="<%= @sort_by_sublot ? 'text-gray-500' : 'text-indigo-600' %>">Mark</span>
                        <span class="mx-0.5 text-gray-400">/</span>
                        <span class="<%= @sort_by_sublot ? 'text-indigo-600' : 'text-gray-500' %>">Sublot</span>
                        <svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <% if @sort_by_sublot %>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                            <% else %>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
                            <% end %>
                        </svg>
                    <% end %>
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sublot</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lane</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Joint <span class="normal-case font-normal text-gray-400">(L-R)</span></th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lot Dist <span class="normal-case font-normal text-gray-400">(ft)</span></th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sublot Dist <span class="normal-case font-normal text-gray-400">(ft)</span></th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lane Dist <span class="normal-case font-normal text-gray-400">(ft)</span></th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Offset <span class="normal-case font-normal text-gray-400">(ft)</span></th>
                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Lock</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            <% current_sublot = nil %>
            <% @core_locations.each_with_index do |loc, index| %>
                <% 
                   is_new_sublot = @sort_by_sublot && current_sublot != loc.sublot_id
                   current_sublot = loc.sublot_id
                %>
                <tr class="<%= 'border-t-4 border-gray-200 bg-gray-50/50' if is_new_sublot %> hover:bg-gray-50 transition-colors cursor-pointer" onclick="toggleRandomNumbers(<%= index %>)">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900"><%= loc.mark %></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <% if loc.mat? %>
                             <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors">
                                MAT
                             </span>
                        <% else %>
                             <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 hover:bg-yellow-200 transition-colors">
                                JOINT
                             </span>
                        <% end %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= loc.sublot.position %></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= loc.lane_index %></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <% if loc.joint? %>
                            <span class="font-mono bg-gray-100 px-1 rounded text-xs">
                                <%= loc.left_lane&.position || loc.left_lane_id %>-<%= loc.right_lane&.position || loc.right_lane_id %>
                            </span>
                        <% else %>
                            <span class="text-gray-300">-</span>
                        <% end %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono"><%= number_with_precision(loc.distance_from_lot_start_ft, precision: 2) %></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono"><%= number_with_precision(loc.linear_in_sublot_ft, precision: 2) %></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                        <% if loc.mat? %>
                            <span class="text-gray-400 text-xs mr-1">L(<%= loc.lane_index %>)</span><%= number_with_precision(loc.station_in_lane_ft, precision: 2) %>
                        <% else %>
                            <%= number_with_precision(loc.station_in_lane_ft, precision: 2) %>
                        <% end %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                        <% if loc.mat? %>
                            <%= number_with_precision(loc.offset_in_lane_ft, precision: 2) %>
                        <% else %>
                            <span class="text-gray-300">-</span>
                        <% end %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm" onclick="event.stopPropagation()">
                        <% locked = loc.sublot.locked_for_core_generation %>
                        <%= button_to toggle_core_lock_sublot_path(loc.sublot), method: :patch, class: "transition-colors p-1 rounded hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 #{locked ? 'text-red-500' : 'text-gray-400 hover:text-gray-600'}", title: locked ? "Locked" : "Unlocked" do %>
                             <% if locked %>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                                </svg>
                             <% else %>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 116 0v2h2V7a5 5 0 00-5-5z" />
                                </svg>
                             <% end %>
                        <% end %>
                    </td>
                </tr>
                <!-- Random Numbers Row (hidden by default) -->
                <tr id="random-row-<%= index %>" class="hidden bg-indigo-50 border-b border-indigo-100">
                    <td colspan="2" class="px-6 py-4 whitespace-nowrap text-sm text-indigo-700 font-medium align-middle">
                        <span class="inline-flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="h-4 w-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                            </svg>
                            <span>Random Numbers</span>
                        </span>
                    </td>
                    <td colspan="5" class="px-6 py-4 align-middle"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-indigo-700 font-mono align-middle">
                        <% if loc.station_random_number.present? %>
                            <span class="bg-indigo-100 text-indigo-800 px-2.5 py-1 rounded"><%= number_with_precision(loc.station_random_number, precision: 4) %></span>
                        <% else %>
                            <span class="text-gray-400 italic">N/A</span>
                        <% end %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-indigo-700 font-mono align-middle">
                        <% if loc.offset_random_number.present? %>
                            <span class="bg-indigo-100 text-indigo-800 px-2.5 py-1 rounded"><%= number_with_precision(loc.offset_random_number, precision: 4) %></span>
                        <% else %>
                            <span class="text-gray-400 italic">N/A</span>
                        <% end %>
                    </td>
                    <td class="px-6 py-4 align-middle"></td>
                </tr>
            <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
function toggleRandomNumbers(index) {
    const row = document.getElementById('random-row-' + index);
    if (row) {
        row.classList.toggle('hidden');
    }
}
</script>
